service: testconverter
frameworkVersion: '2'

provider:
  name: aws
  region: eu-central-1
  memorySize: 128
  lambdaHashingVersion: 20201221

#functions:
#  Converter:
#    handler: handler.hello

#    Define function environment variables here
#    environment:
#      variable2: value2

custom:
  stage: ${opt:stage, self:provider.stage}
  extra: ${file(vars/${self:custom.stage}.yml)}

resources:
  Resources:
    ConvertFileQueue:
      Type: "AWS::SQS::Queue"

    ConvertFileQueuePolicy:
      Type: "AWS::SQS::QueuePolicy"
      Properties:
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Sid: Allow-SNS-SendMessage
            Effect: Allow
            Principal: "*"
            Action:
              - sqs:SendMessage
            Resource: !GetAtt ConvertFileQueue.Arn
            Condition:
              ArnEquals:
                aws:SourceArn: ${self:custom.extra.FileUploadedTopic}
        Queues:
          - !Ref ConvertFileQueue

    ConvertFileQueueSubscription:
      Type: AWS::SNS::Subscription
      Properties:
        Protocol: sqs
        Endpoint: !GetAtt ConvertFileQueue.Arn
        Region: "${self:provider.region}"
        TopicArn: ${self:custom.extra.FileUploadedTopic}
        RawMessageDelivery: 'true'
